<!DOCTYPE html>
<html>

<head>
  <title>Atoms | vanilla</title>

  <style>
    .selected {
      background-color: pink;
    }
  </style>
  <script src="./p5.js"></script>
  <script src="./addons/p5.sound.js"></script>
  <script type="module">
    import { program as generateVoices } from './atoms/atoms.js';
    import { draw as doDraw } from './atoms/visuals/draw.js';
    import { setupInstrument, play as playFn } from './atoms/instrument.js';

    window.generateVoices = generateVoices;
    window.doDraw = doDraw;
    window.setupInstrument = setupInstrument;
    window.playFn = playFn;
  </script>

  <script>
    let i = 0;
    let beat = 0;
    let voices = undefined;
    let lastNote = 0;
    let samples = undefined;
    let loaded = false;
    let tmp = -1;
    let state = { 1: 1, 2: 1, 3: 1, 4: 1, 5: 1, 6: 1 };
    let NUMBER_OF_FRAMES = 10; // 90 bpm
    const TOTAL_NUMBER_OF_BEATS = 64 * 4 * 32; // 64 * 4 * 32; // 32 bars

    const x = document.getElementsByClassName("example");

    const updateState = (num) => {
      const row = num[0];
      const col = +num[1];

      const ns = { ...state, [row]: col };

      const { voices: vc, tempo: numberOfFrames } = window.generateVoices(ns['1'], ns['2'], ns['3'], ns['4'], ns['5'], ns['6']);

      voices = vc;
      state = ns;
      NUMBER_OF_FRAMES = numberOfFrames;
    }


    function setup() {
      const { voices: vc } = window.generateVoices(1, 3, 1, 3, 3, 2);

      voices = vc;

      const ctx = getAudioContext();
      ctx.suspend();
      createCanvas(1000, 1000);

      window.setupInstrument(ctx).then(smpls => {
        samples = smpls;
        loaded = true;
      });

      Object.keys(x).forEach(key => {
        x[key].addEventListener('click', () => {
          const theId = x[key].id;
          updateState(theId);
          const rw = theId[0];
          const cl = theId[1];
          for (let j = 0; j < 5; j++) {
            const jj = +j + 1;
            const k = rw + '' + jj;
            console.log('>>k ', k)
            const y = document.getElementById(k);
            y.classList.remove("selected");
          }

          const y = document.getElementById(theId);
          y.classList.add("selected");
        });
      })
    }

    function draw() {
      if (!loaded) {
        return;
      }

      const audioContext = getAudioContext();
      if (audioContext.state === 'running') {
        const currentNotes = voices[beat];

        if (beat !== tmp) {
          tmp = beat;
          playNow(audioContext, currentNotes);
        }

        window.doDraw(NUMBER_OF_FRAMES, i, tmp, currentNotes);

        increase();
      }
    }

    const playNow = (audioContext, currentNotes) => {
      currentNotes.forEach(currentNote => {
        const [pitch, noteLength] = currentNote;

        const dur = 0.3;
        if (!!pitch) {
          const t = audioContext.currentTime;
          window.playFn(audioContext, samples, pitch, t, dur);
        }
      });
    }

    function mousePressed() {
      if (getAudioContext().state === 'running') {
        // getAudioContext().suspend();
      } else {
        userStartAudio();
      }
    }

    const getBpm = (x) => 60 / (60 / 3600 * x * 4);
    const getMs = (x) => 60 / 3600 * x * 4;

    const increase = () => {
      if (i < NUMBER_OF_FRAMES) {
        i = i + 1;
      } else {
        if (beat < TOTAL_NUMBER_OF_BEATS - 1) {
          beat = beat + 1;
        } else {
          beat = 0;
        }

        i = 0;
      }
    }
  </script>
</head>

<body>
  <div style="display: flex; flex-direction: row;">
    <div style="width: 100px; background-color: pink;">melody:</div>

    <button class="example" id="11">1</button>
    <button class="example" id="12">2</button>
    <button class="example" id="13">3</button>
    <button class="example" id="14">4</button>
    <button class="example" id="15">5</button>
  </div>

  <div style="display: flex; flex-direction: row;">
    <div style="width: 100px; background-color: pink;">melo trans:</div>

    <button class="example" id="21">1</button>
    <button class="example" id="22">2</button>
    <button class="example" id="23">3</button>
    <button class="example" id="24">4</button>
    <button class="example" id="25">5</button>
  </div>

  <div style="display: flex; flex-direction: row;">
    <div style="width: 100px; background-color: pink;">rythm trans:</div>
    <button class="example" id="31">1</button>
    <button class="example" id="32">2</button>
    <button class="example" id="33">3</button>
    <button class="example" id="34">4</button>
    <button class="example" id="35">5</button>
  </div>

  <div style="display: flex; flex-direction: row;">
    <div style="width: 100px; background-color: pink;">voices:</div>
    <button class="example" id="41">1</button>
    <button class="example" id="42">2</button>
    <button class="example" id="43">3</button>
    <button class="example" id="44">4</button>
    <button class="example" id="45">5</button>
  </div>

  <div style="display: flex; flex-direction: row;">
    <div style="width: 100px; background-color: pink;">tempo:</div>
    <button class="example" id="51">1</button>
    <button class="example" id="52">2</button>
    <button class="example" id="53">3</button>
    <button class="example" id="54">4</button>
    <button class="example" id="55">5</button>
  </div>

  <div style="display: flex; flex-direction: row;">
    <div style="width: 100px; background-color: pink;">transpose:</div>
    <button class="example" id="61">1</button>
    <button class="example" id="62">2</button>
    <button class="example" id="63">3</button>
    <button class="example" id="64">4</button>
    <button class="example" id="65">5</button>
  </div>

</body>

</html>

<!--
   // const tempo = getBpm(NUMBER_OF_FRAMES) + ' bpm';
      // const ms = getMs(NUMBER_OF_FRAMES) + ' ms';

      // const [pitch, noteLength] = voices[beat][0];

      // if (pitch !== null) {
      //   lastNote = pitch;
      // }

      // background(255, 500, 500);
      // textAlign(CENTER, CENTER);
      // text(lastNote, 100, 100);
-->