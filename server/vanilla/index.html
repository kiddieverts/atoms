<!DOCTYPE html>
<html>

<head>
  <title>Atoms | vanilla</title>

  <link rel="stylesheet" href="index.css">

  <style>
    /* .selected {
      background-color: pink;
    } */
  </style>
  <script src="./p5.js"></script>
  <script src="./addons/p5.sound.js"></script>
  <script type="module">
    import { program as generateVoices } from './atoms/atoms.js';
    import { draw as doDraw } from './atoms/visuals/draw.js';
    import { setupInstrument, play as playFn } from './atoms/instrument.js';

    window.generateVoices = generateVoices;
    window.doDraw = doDraw;
    window.setupInstrument = setupInstrument;
    window.playFn = playFn;
  </script>

  <script>
    let i = 0;
    let beat = 0;
    let voices = undefined;
    let lastNote = 0;
    let samples = undefined;
    let loaded = false;
    let tmp = -1;
    let state = { 1: 1, 2: 1, 3: 1, 4: 3, 5: 5, 6: 3 };
    let NUMBER_OF_FRAMES = 10; // 90 bpm
    const TOTAL_NUMBER_OF_BEATS = 32 * 8; // 64 * 4 * 32; // 32 bars

    const updateState = (num) => {
      const row = num[0];
      const col = +num[1];

      const ns = { ...state, [row]: col };

      const { voices: vc, tempo: numberOfFrames } = window.generateVoices(ns['1'], ns['2'], ns['3'], ns['4'], ns['5'], ns['6']);

      voices = vc;
      state = ns;
      NUMBER_OF_FRAMES = numberOfFrames;
    }

    const updateAllState = (ns) => {
      const { voices: vc, tempo: numberOfFrames } = window.generateVoices(ns['1'], ns['2'], ns['3'], ns['4'], ns['5'], ns['6']);

      voices = vc;
      state = ns;
      NUMBER_OF_FRAMES = numberOfFrames;
    }

    function setup() {
      const { voices: vc } = window.generateVoices(1, 3, 1, 3, 3, 2);

      voices = vc;

      const loc = window.location;
      if (loc.search.length === 7) {
        const daId = loc.search.substring(1, loc.search.length);
        const one = +daId[0];
        const two = +daId[1];
        const three = +daId[2];
        const four = +daId[3];
        const five = +daId[4];
        const six = +daId[5];

        console.log(one, two, three, four, five, six)

        st = { 1: one, 2: two, 3: three, 4: four, 5: five, 6: six };
        updateAllState(st);
      }

      const ctx = getAudioContext();
      ctx.suspend();

      const cv = createCanvas(windowWidth, windowHeight);

      background(0)

      // drawBackground();
      // setupPosition();

      cv.position(0, 0);

      window.setupInstrument(ctx).then(smpls => {
        samples = smpls;
        loaded = true;
      });

      const x = document.getElementsByClassName("tile");

      Object.keys(x).forEach(key => {
        x[key].addEventListener('click', () => {
          const theId = x[key].id;
          updateState(theId);
          updateCss(theId);
        })
      });

      const btn = document.getElementById('btn');

      const pads = document.getElementById('pads');

      btn.addEventListener('click', () => {
        if (pads.style.display === 'flex') {
          pads.style.display = 'none';
        } else {
          pads.style.display = 'flex';
        }
      });
    }

    const updateCss = (id) => {
      console.log('updateCss', id)
      const row = id[0];
      const col = id[1];
      for (let j = 0; j < 5; j++) {
        const cl = +j + 1;
        const k = row + '' + cl;
        const el = document.getElementById(k);
        el.classList.remove("selected");
      }

      const el = document.getElementById(id);
      el.classList.add("selected");
    }

    // function setupPosition () {
    //     x = p.windowWidth / 2;
    //     y = p.windowHeight / 2;
    //   };

    function draw() {
      if (!loaded) {
        return;
      }

      const audioContext = getAudioContext();
      if (audioContext.state === 'running') {
        const currentNotes = voices[beat];

        if (beat !== tmp) {
          tmp = beat;
          playNow(audioContext, currentNotes);
        }

        window.doDraw(NUMBER_OF_FRAMES, i, tmp, currentNotes, state, windowWidth, windowHeight);

        increase();
      }
    }

    const playNow = (audioContext, currentNotes) => {
      currentNotes.forEach(currentNote => {
        const [pitch, noteLength] = currentNote;

        const dur = 0.3;
        if (!!pitch) {
          const t = audioContext.currentTime;
          window.playFn(audioContext, samples, pitch, t, dur);
        }
      });
    }

    function mousePressed() {
      if (getAudioContext().state === 'running') {
        // getAudioContext().suspend();
      } else {
        userStartAudio();
      }
    }

    const getBpm = (x) => 60 / (60 / 3600 * x * 4);
    const getMs = (x) => 60 / 3600 * x * 4;

    const increase = () => {
      if (i < NUMBER_OF_FRAMES) {
        i = i + 1;
      } else {
        if (beat < TOTAL_NUMBER_OF_BEATS - 1) {
          beat = beat + 1;
        }
        else {
          getAudioContext().suspend();
          saveFrames('out', 'png', 1, 1);
        }
        // else {
        //   beat = 0;
        // }

        i = 0;
      }
      console.log(beat, TOTAL_NUMBER_OF_BEATS);
    }
  </script>
</head>

<body>
  <div style="display: none; flex-direction: row;" id="pads">
    <div>
      <div style="display: flex; flex-direction: row;">
        <div class="tile-static cent">melody</div>

        <div class="tile" id="11"></div>
        <div class="tile" id="12"></div>
        <div class="tile" id="13"></div>
        <div class="tile" id="14"></div>
        <div class="tile" id="15"></div>
      </div>

      <div style="display: flex; flex-direction: row;">
        <div class="tile-static cent">melo trans</div>

        <div class="tile" id="21"></div>
        <div class="tile" id="22"></div>
        <div class="tile" id="23"></div>
        <div class="tile" id="24"></div>
        <div class="tile" id="25"></div>
      </div>

      <div style="display: flex; flex-direction: row;">
        <div class="tile-static cent">rythm trans</div>
        <div class="tile" id="31"></div>
        <div class="tile" id="32"></div>
        <div class="tile" id="33"></div>
        <div class="tile" id="34"></div>
        <div class="tile" id="35"></div>
      </div>

      <div style="display: flex; flex-direction: row;">
        <div class="tile-static cent">voices</div>
        <div class="tile" id="41"></div>
        <div class="tile" id="42"></div>
        <div class="tile" id="43"></div>
        <div class="tile" id="44"></div>
        <div class="tile" id="45"></div>
      </div>

      <div style="display: flex; flex-direction: row;">
        <div class="tile-static cent">tempo</div>
        <div class="tile" id="51"></div>
        <div class="tile" id="52"></div>
        <div class="tile" id="53"></div>
        <div class="tile" id="54"></div>
        <div class="tile" id="55"></div>
      </div>

      <div style="display: flex; flex-direction: row;">
        <div class="tile-static cent">transpose</div>
        <div class="tile" id="61"></div>
        <div class="tile" id="62"></div>
        <div class="tile" id="63"></div>
        <div class="tile" id="64"></div>
        <div class="tile" id="65"></div>
      </div>
    </div>
  </div>

  <div style="display: none">
    <div style="font-size: 18px;" id="btn">hide/show</div>
  </div>

</body>

</html>

<!--
   // const tempo = getBpm(NUMBER_OF_FRAMES) + ' bpm';
      // const ms = getMs(NUMBER_OF_FRAMES) + ' ms';

      // const [pitch, noteLength] = voices[beat][0];

      // if (pitch !== null) {
      //   lastNote = pitch;
      // }

      // background(255, 500, 500);
      // textAlign(CENTER, CENTER);
      // text(lastNote, 100, 100);
-->